<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="manifest" href="/manifest.json">
  <meta charset="UTF-8">
  <meta name="Description" content="Digital [White|Black]Boards with Real-Time support">
  <meta name="viewport" content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>

  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="LiveBoards">
  <link rel="apple-touch-icon" href="/images/icons/icon-152x152.png">


  <meta name="theme-color" content="#FFFFFF" />

  <title>LiveBoards</title>
  <link rel="stylesheet" href="/css/bulma.min.css">
  <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      scrollbar-width: none;
      background-color: white;
      overflow: hidden;
      height: 100%;
      touch-action: none;
    }

    canvas {
      border: 1px solid #AAA;
      user-select: none;
    }

    button {
      width: 40px;
      height: 30px;
    }

    .noselect {
      -webkit-touch-callout: none;
      /* iOS Safari */
      -webkit-user-select: none;
      /* Safari */
      -khtml-user-select: none;
      /* Konqueror HTML */
      -moz-user-select: none;
      /* Old versions of Firefox */
      -ms-user-select: none;
      /* Internet Explorer/Edge */
      user-select: none;
    }
  </style>
</head>

<body class="noselect">
  <canvas id="draw" width="800" height="800" class="noselect"></canvas>
  <div class="container noselect">
    <div class="content">
      <form id="toolbar" class="form">
        <div class="field is-horizontal">
          <div class="field-body">
            <div class="field">
              <button id="themeButton" type="button" aria-label="Change Theme" class="button is-small">ðŸŒ“</button>
              <button id="newButton" type="button" aria-label="New Board" class="button is-small is-primary">
                <span class="icon">
                  <i class="fas fa-file"></i>
                </span>
              </button>
              <button id="downloadButton" type="button" aria-label="Download" class="button is-small is-success">
                <span class="icon">
                  <i class="fas fa-download"></i>
                </span>
              </button>
              <button id="shareButton" type="button" aria-label="Share Board" class="button is-small is-info">
                <span class="icon">
                  <i class="fas fa-share"></i>
                </span>
              </button>
            </div>
            <div class="field">
              <p class="control is-expanded has-icons-left">
                <input id="colorInput" type="color" value="#000000" class="input is-small">
                <span class="icon is-small is-left">
                  <i class="fas fa-palette"></i>
                </span>
              </p>
            </div>
            <div class="field">
              <p class="control is-expanded has-icons-left">
                <input id="sizeInput" type="range" min="5" max="50" value="10" class="input is-small">
                <span class="icon is-small is-left">
                  <i class="fas fa-pencil-alt"></i>
                </span>
              </p>
            </div>
            <div class="field">
              <div class="field-group is-pulled-right">
                <button id="refreshButton" type="button" aria-label="Refresh Page" class="button is-small is-warning">
                  <span class="icon">
                    <i class="fas fa-retweet"></i>
                  </span>
                </button>
                <button id="clearButton" type="button" aria-label="Clear Screen" class="button is-small is-danger">
                  <span class="icon">
                    <i class="fas fa-eraser"></i>
                  </span>
                </button>
              </div>

            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
  <!-- <footer>
    All emojis designed by OpenMoji â€“ the open-source emoji and icon project. License: CC BY-SA 4.0
  </footer> -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
  <script>
    const boardID = location.href.substr(-36)
    const canDraw = boardID === document.cookie.substr(6)
    const socket = io();
    const toolbar = document.getElementById('toolbar');
    const canvas = document.getElementById('draw');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth - 2;
    canvas.height = window.innerHeight - toolbar.getBoundingClientRect().height - 20;
    ctx.strokeStyle = '#BADA55';
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    currentColor = '#000';
    currentLineSize = 10;
    const backgroundColor = 'white'
    const borderColor = 'black'
    const DESCRIPTION = 'Digital [White|Black]Boards with Real-Time support'
    // ctx.globalCompositeOperation = 'multiply';

    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    let hue = 0;

    function clearCanvas() {
      canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = backgroundColor;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawLine(line) {
      ctx.strokeStyle = line.color;
      ctx.lineWidth = line.size * line.pressure;
      ctx.beginPath();
      ctx.moveTo(line.beginX, line.beginY);
      ctx.lineTo(line.endX, line.endY);
      ctx.stroke();
      hue++;
      if (hue >= 360) {
        hue = 0;
      }
    }

    function draw(event) {
      event.preventDefault()
      if (!isDrawing || !canDraw) return;
      newLine = {
        beginX: lastX,
        beginY: lastY,
        endX: event.clientX,
        endY: event.clientY,
        color: currentColor,
        size: currentLineSize,
        pressure: event.pressure || 1
      }
      drawLine(newLine);
      [lastX, lastY] = [event.clientX, event.clientY];
      socket.emit('newline', boardID, newLine);
    }

    function movimentStarted(event) {
      event.preventDefault();
      isDrawing = true;
      [lastX, lastY] = [event.clientX, event.clientY];
    }

    function movementEnded(event) {
      event.preventDefault();
      isDrawing = false;
    }

    function downloadImage() {
      var link = document.createElement('a');
      link.download = 'liveboard.png';
      link.href = canvas.toDataURL()
      link.click();
    }

    function goToURL(url) {
      var link = document.createElement('a');
      link.href = url
      link.click();
    }

    document.addEventListener("DOMContentLoaded", function () {
      socket.emit('create', boardID);

      canvas.addEventListener('pointerdown', movimentStarted);
      canvas.addEventListener('pointermove', draw);
      canvas.addEventListener('pointerup', movementEnded);
      canvas.addEventListener('pointerout', movementEnded);

      clearCanvas()
      canvas.style.borderColor = borderColor;

      socket.on('drawline', function (line) {
        drawLine(line)
      });
      socket.on('clear', function (msg) {
        clearCanvas()
      });

      const newButton = document.getElementById('newButton')
      newButton.addEventListener('click', function (event) {
        goToURL('/new')
      })

      const shareButton = document.getElementById('shareButton')
      if (navigator.share) {
        shareButton.addEventListener('click', async function (event) {
          const url = location.href

          const shareData = {
            title: document.title,
            text: DESCRIPTION,
            url: url
          }
          navigator.share(shareData).then(
            () => {
              console.info("Shared!")
            },
            (err) => {
              console.error(err)
            })
        })
      } else {
        const clipboard = new ClipboardJS(
          shareButton,
          {
            text: function (trigger) {
              return location.href;
            }
          }
        );
        clipboard.on('success', function (e) {
          alert('Url copiada com sucesso!')
        })
      }
      
      const downloadButton = document.getElementById('downloadButton')
      downloadButton.addEventListener('click', function (event) {
        downloadImage()
      })

      const colorInput = document.getElementById('colorInput')
      colorInput.addEventListener('change', function (event) {
        currentColor = event.target.value;
      })
      currentColor = colorInput.value

      const sizeInput = document.getElementById('sizeInput')
      sizeInput.addEventListener('change', function (event) {
        currentLineSize = event.target.value;
      })
      currentLineSize = sizeInput.value

      const refreshButton = document.getElementById('refreshButton')
      refreshButton.addEventListener('click', function (event) {
        location.reload()
      })

      const clearButton = document.getElementById('clearButton')
      clearButton.addEventListener('click', function (event) {
        if (confirm('Tem certeza que deseja limpar o quadro?')) {
          clearCanvas();
          socket.emit('clear', boardID);
        }
      })

      const editorToolbarItens = [clearButton, colorInput, sizeInput]
      editorToolbarItens.forEach(element => {
        if (!canDraw) {
          element.classList.add('is-hidden')
        }
      });

    });


    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(registration => {
          console.log('SW registered: ', registration);
        }).catch(registrationError => {
          console.log('SW registration failed: ', registrationError);
        });
      });
    }


  </script>
</body>

</html>