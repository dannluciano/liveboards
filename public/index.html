<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="Description" content="Digital [White|Black]Boards with Real-Time support">
  <meta name="viewport" content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>
  <title>LiveBoards</title>
  <script src="https://kit.fontawesome.com/501d159087.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="css/bulma.min.css">
  <style>
    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      scrollbar-width: none;
      background-color: white;
      overflow: hidden;
      height: 100%;
      touch-action: none;
    }

    canvas {
      border: 1px solid #AAA;
      user-select: none;
    }

    button {
      width: 40px;
      height: 30px;
    }

    .noselect {
      -webkit-touch-callout: none;
      /* iOS Safari */
      -webkit-user-select: none;
      /* Safari */
      -khtml-user-select: none;
      /* Konqueror HTML */
      -moz-user-select: none;
      /* Old versions of Firefox */
      -ms-user-select: none;
      /* Internet Explorer/Edge */
      user-select: none;
    }
  </style>
</head>

<body class="noselect">
  <canvas id="draw" width="800" height="800" class="noselect"></canvas>
  <div class="container noselect">
    <div class="content">
      <form id="toolbar" class="form">
        <div class="field is-horizontal">
          <div class="field-body">
            <div class="field">
              <button id="themeButton" type="button" aria-label="Change Theme" class="button is-small">ðŸŒ“</button>
              <button id="clearButton" type="button" aria-label="Clear Screen" class="button is-small is-danger">
                <span class="icon">
                  <i class="fas fa-eraser"></i>
                </span>
              </button>
              <button id="downloadButton" type="button" aria-label="Download" class="button is-small is-success">
                <span class="icon">
                  <i class="fas fa-download"></i>
                </span>
              </button>
            </div>
            <div class="field">
              <p class="control is-expanded has-icons-left">
                <input id="colorInput" type="color" value="#00000" class="input is-small">
                <span class="icon is-small is-left">
                  <i class="fas fa-palette"></i>
                </span>
              </p>
            </div>
            <div class="field">
              <p class="control is-expanded has-icons-left">
                <input id="sizeInput" type="range" min="5" max="50" value="10" class="input is-small">
                <span class="icon is-small is-left">
                  <i class="fas fa-pencil-alt"></i>
                </span>
              </p>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const toolbar = document.getElementById('toolbar');
    const canvas = document.getElementById('draw');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth - 2;
    canvas.height = window.innerHeight - toolbar.getBoundingClientRect().height - 20;
    ctx.strokeStyle = '#BADA55';
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    currentColor = '#000';
    currentLineSize = 10;
    const backgroundColor = 'white'
    const borderColor = 'black'
    // ctx.globalCompositeOperation = 'multiply';

    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    let hue = 0;

    function clearCanvas() {
      canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = backgroundColor;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawLine(line) {
      ctx.strokeStyle = line.color;
      ctx.lineWidth = line.size * line.pressure;
      ctx.beginPath();
      ctx.moveTo(line.beginX, line.beginY);
      ctx.lineTo(line.endX, line.endY);
      ctx.stroke();
      hue++;
      if (hue >= 360) {
        hue = 0;
      }
    }

    function draw(event) {
      event.preventDefault()
      if (!isDrawing) return;
      newLine = {
        beginX: lastX,
        beginY: lastY,
        endX: event.clientX,
        endY: event.clientY,
        color: currentColor,
        size: currentLineSize,
        pressure: event.pressure || 1
      }
      drawLine(newLine);
      [lastX, lastY] = [event.clientX, event.clientY];
      socket.emit('newline', newLine);
      console.log(event)
    }

    function movimentStarted(event) {
      event.preventDefault();
      isDrawing = true;
      [lastX, lastY] = [event.clientX, event.clientY];
    }

    function movementEnded(event) {
      event.preventDefault();
      isDrawing = false;
    }

    function downloadImage() {
      var link = document.createElement('a');
      link.download = 'liveboard.png';
      link.href = canvas.toDataURL()
      link.click();
    }

    document.addEventListener("DOMContentLoaded", function () {
      clearCanvas()
      canvas.style.borderColor = borderColor;

      socket.on('drawline', function (line) {
        drawLine(line)
      });
      socket.on('clear', function (msg) {
        clearCanvas()
      });

      const clearButton = document.getElementById('clearButton')
      clearButton.addEventListener('click', function (event) {
        socket.emit('clear', true);
      })

      const downloadButton = document.getElementById('downloadButton')
      downloadButton.addEventListener('click', function (event) {
        downloadImage()
      })

      const colorInput = document.getElementById('colorInput')
      colorInput.addEventListener('change', function (event) {
        currentColor = event.target.value;
      })
      currentColor = colorInput.value

      const sizeInput = document.getElementById('sizeInput')
      sizeInput.addEventListener('change', function (event) {
        currentLineSize = event.target.value;
      })
      currentLineSize = sizeInput.value

    });

    canvas.addEventListener('pointerdown', movimentStarted);
    canvas.addEventListener('pointermove', draw);
    canvas.addEventListener('pointerup', movementEnded);
    canvas.addEventListener('pointerout', movementEnded);

    document.addEventListener("keyup", function (e) {
      switch (e.which) {
        // ESC
        case 27:
          socket.emit('clear', true);
          break;
      }
    });

  </script>

</body>

</html>